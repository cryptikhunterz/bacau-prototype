---
phase: 03-app-integration
plan: 01
type: execute
---

<objective>
Integrate pitch control visualization into the Streamlit app.

Purpose: Enable users to see real-time spatial dominance overlay showing which team controls each area of the pitch.
Output: Modified `app.py` with pitch control toggle, opacity slider, and heatmap overlay in render_frame().
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./03-01-SUMMARY.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/pitch_control.py
@src/velocity.py
@app.py

**Prior Phase Deliverables:**
- Phase 1: `src/velocity.py` - calculate_velocities(), smooth_velocities(), clamp_velocities()
- Phase 2: `src/pitch_control.py` - create_pitch_grid(), compute_pitch_control()

**Existing App Structure:**
- Sidebar controls: lines 1093-1205 (show_shapes, show_ball, show_zones checkboxes)
- Session state: current_frame, log, debug_log, perf_metrics
- render_frame(): lines 993-1060, returns matplotlib figure
- extract_positions(): lines 77-101, returns {'home': {}, 'away': {}}
- Main render loop: lines 1216-1247

**Integration Pattern:**
Follow existing patterns for checkboxes and sliders in sidebar Display Options section.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sidebar controls for pitch control</name>
  <files>app.py</files>
  <action>
In the sidebar Display Options section (after line 1130 where show_zones is defined):

1. Add pitch control toggle checkbox:
   ```python
   show_pitch_control = st.checkbox("Show pitch control", value=False)
   ```

2. Add alpha slider (only shown when pitch control enabled):
   ```python
   if show_pitch_control:
       pitch_control_alpha = st.slider("Pitch control opacity", 0.1, 0.9, 0.5, 0.1)
   else:
       pitch_control_alpha = 0.5
   ```

3. Add imports at top of file (after line 27):
   ```python
   from pitch_control import create_pitch_grid, compute_pitch_control
   from velocity import calculate_velocities, smooth_velocities, clamp_velocities
   ```
  </action>
  <verify>App runs without import errors: `streamlit run app.py` shows new controls in sidebar</verify>
  <done>Sidebar shows "Show pitch control" checkbox and conditional opacity slider</done>
</task>

<task type="auto">
  <name>Task 2: Add state management for velocity calculation</name>
  <files>app.py</files>
  <action>
Add session state for previous frame positions to enable velocity calculation.

1. In session state initialization section (around line 1067), add:
   ```python
   if 'prev_frame_data' not in st.session_state:
       st.session_state.prev_frame_data = None
   if 'velocities' not in st.session_state:
       st.session_state.velocities = {'home': {}, 'away': {}}
   ```

2. In the main render loop (after frame_data extraction around line 1221), add velocity calculation:
   ```python
   # Calculate velocities for pitch control
   if show_pitch_control and st.session_state.prev_frame_data is not None:
       fps = 29.97
       for team in ['home', 'away']:
           prev_pos = st.session_state.prev_frame_data.get(team, {})
           curr_pos = frame_data.get(team, {})
           if prev_pos and curr_pos:
               raw_vel = calculate_velocities(curr_pos, prev_pos, fps=fps)
               prev_vel = st.session_state.velocities.get(team, {})
               smoothed = smooth_velocities(raw_vel, prev_vel, alpha=0.3)
               st.session_state.velocities[team] = clamp_velocities(smoothed, max_speed=13.0)
           else:
               st.session_state.velocities[team] = {pid: (0.0, 0.0) for pid in curr_pos}

   # Store current frame for next iteration
   st.session_state.prev_frame_data = frame_data
   ```
  </action>
  <verify>No errors on frame navigation. Check session_state.velocities has data when pitch control enabled.</verify>
  <done>Velocities calculated from frame-to-frame position deltas with EMA smoothing</done>
</task>

<task type="auto">
  <name>Task 3: Add pitch control overlay to render_frame</name>
  <files>app.py</files>
  <action>
Modify render_frame() to overlay pitch control heatmap.

1. Update render_frame() signature (line 993):
   ```python
   def render_frame(frame_data, ball_pos=None, home_name="Home", away_name="Away",
                    show_shapes=True, possession=None, show_zones=False,
                    show_pitch_control=False, pitch_control_alpha=0.5,
                    home_velocities=None, away_velocities=None):
   ```

2. Inside render_frame(), before drawing players (around line 1003), add pitch control overlay:
   ```python
   # Draw pitch control overlay if enabled
   if show_pitch_control:
       from matplotlib.colors import LinearSegmentedColormap

       home_pos = frame_data.get('home', {})
       away_pos = frame_data.get('away', {})

       if home_pos and away_pos:
           # Use provided velocities or default to zero
           h_vel = home_velocities or {pid: (0.0, 0.0) for pid in home_pos}
           a_vel = away_velocities or {pid: (0.0, 0.0) for pid in away_pos}

           # Compute pitch control
           control = compute_pitch_control(home_pos, away_pos, h_vel, a_vel)
           x_grid, y_grid = create_pitch_grid()

           # Blue-white-red colormap (home=blue, contested=white, away=red)
           colors = ['#e74c3c', '#FFFFFF', '#3498db']  # Red -> White -> Blue
           cmap = LinearSegmentedColormap.from_list('pitch_control', colors)

           # Draw on both axes
           for ax_current in [ax1, ax2]:
               ax_current.pcolormesh(x_grid, y_grid, control, cmap=cmap,
                                    vmin=0, vmax=1, alpha=pitch_control_alpha, zorder=1)
   ```

3. Update render_frame() call in main loop (around line 1227):
   ```python
   fig = render_frame(frame_data, ball_pos, home_name, away_name, show_shapes, possession, show_zones,
                      show_pitch_control, pitch_control_alpha,
                      st.session_state.velocities.get('home'),
                      st.session_state.velocities.get('away'))
   ```
  </action>
  <verify>Enable pitch control checkbox, navigate frames, verify blue-white-red gradient appears behind players</verify>
  <done>Pitch control heatmap renders correctly with adjustable opacity</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pitch control visualization integrated into Streamlit app</what-built>
  <how-to-verify>
    1. Run: `streamlit run app.py` from project directory
    2. In sidebar, find "Display Options" section
    3. Check "Show pitch control" checkbox
    4. Verify: Blue-white-red gradient appears behind players
    5. Adjust opacity slider - overlay transparency should change
    6. Navigate frames with slider - control zones should update with player positions
    7. Confirm: Blue areas near home team (Germany), red near away team (Japan)
    8. Confirm: White areas in contested/neutral zones
  </how-to-verify>
  <resume-signal>Type "approved" if visualization works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `streamlit run app.py` starts without errors
- [ ] Pitch control checkbox appears in sidebar
- [ ] Alpha slider appears when checkbox enabled
- [ ] Heatmap overlay renders behind players
- [ ] Colors correct: blue=home, white=contested, red=away
- [ ] Opacity slider adjusts transparency
- [ ] Frame navigation updates control zones
- [ ] No performance degradation (app remains responsive)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Pitch control overlay visually correct
- User can toggle visibility and adjust opacity
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-app-integration/03-01-SUMMARY.md`:

# Phase 3 Plan 1: App Integration Summary

**[One-liner: what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Modified

- `app.py` - Description of changes

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 3 complete. Ready for Phase 4: Documentation.
</output>
